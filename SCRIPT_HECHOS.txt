=== SCRIPT LLENADO TABLA HECHOS ====



--LLENADO DE TABLAS HECHO


-- TABLA HECHO_VENTAS : SCRIPT
TRUNCATE TABLE [DATAMART_DELTRON_BD].[dbo].[HECHO_VENTAS]
GO
INSERT [DATAMART_DELTRON_BD].[dbo].[HECHO_VENTAS]
(CLIENTEKEY,PRODUCTOKEY,TIEMPOKEY,ORGANIZACIONKEY,PROMOCIONKEY,FORMAPAGOKEY,MONTOSVENDIDOS,UNIDADESVENDIDAS)
SELECT DCLI.KeyCliente,DPROD.KeyProducto,DTIEM.KeyTiempo,DORG.KeyOrganizacion,DPROM.KeyPromocion,DFORM.KeyFormaPago,
SUM(DET.Cantidad*DET.PrecioUnitario) AS MONTOSVENDIDOS,
SUM(DET.Cantidad) AS UNIDADESVENDIDAS
FROM PRODUCTO PROD INNER JOIN DETAPEDIDO DET
ON PROD.CodProducto=DET.CodProducto
INNER JOIN PEDIDO PED ON PED.CodPedido=DET.CodPedido
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_PRODUCTO DPROD ON DPROD.idProducto=PROD.CodProducto
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_CLIENTE DCLI ON DCLI.idCliente=PED.CodCliente
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_TIEMPO DTIEM ON DTIEM.idFecha=CAST(PED.FechaPedido AS DATE)
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_ORGANIZACION DORG ON DORG.idDespacho=PED.CodDespacho
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_PROMOCION DPROM ON DPROM.idPromocion=DET.CodPromocion
INNER JOIN [DATAMART_DELTRON_BD].DBO.DIM_FORMAPAGO DFORM ON DFORM.idFormaPago=PED.CodFormaPago
GROUP BY DCLI.KeyCliente,DPROD.KeyProducto,DTIEM.KeyTiempo,DORG.KeyOrganizacion,DPROM.KeyPromocion,DFORM.KeyFormaPago







---
GO  -- TABLA HECHO_ESTIMACION : SCRIPT
TRUNCATE TABLE [DATAMART_DELTRON_BD].[dbo].[HECHO_ESTIMACION]
go
INSERT [DATAMART_DELTRON_BD].[dbo].[HECHO_ESTIMACION]
(TiempoKey,ProductoKey,OrganizacionKey,VentaEsperada,UnidadesMeta)
SELECT DTIEM.KeyTiempo,DPROD.KeyProducto,DORG.KeyOrganizacion,
SUM(META.CANTIDAD*PROD.PRECIO) AS VENTAESPERADA,
SUM(META.Cantidad)AS UnidadesMeta
FROM ProductoDespachoMeta META
INNER JOIN PRODUCTO PROD ON PROD.CodProducto=meta.CodProducto
INNER JOIN DESPACHO DSP ON DSP.CodDespacho=META.CodDespacho
INNER JOIN DATAMART_DELTRON_BD.DBO.DIM_PRODUCTO DPROD ON DPROD.idProducto=META.CodProducto  
INNER JOIN DATAMART_DELTRON_BD.DBO.DIM_ORGANIZACION DORG ON DORG.idDespacho=META.CodDespacho 
INNER JOIN PEDIDO PED ON PED.CodDespacho=DSP.CodDespacho									 
INNER JOIN DATAMART_DELTRON_BD.DBO.DIM_TIEMPO DTIEM ON DTIEM.idFecha=CAST(PED.FechaPedido AS DATE) 
WHERE YEAR(PED.FechaPedido)=2023 AND DTIEM.Año=2023 AND META.Año=2023 AND DTIEM.NroMes=META.Mes AND PED.CodDespacho=META.CodDespacho AND PROD.CodProducto=DPROD.idProducto
GROUP BY DTIEM.KeyTiempo,DPROD.KeyProducto,DORG.KeyOrganizacion






--LLENADO TABLA HECHOS ACTIVIDADCLIENTE
TRUNCATE TABLE [DATAMART_DELTRON_BD].[dbo].[HECHO_ACTIVIDADCLIENTES]
INSERT [DATAMART_DELTRON_BD].[dbo].[HECHO_ACTIVIDADCLIENTES]
(ClienteKey,TiempoKey,OrganizacionKey,NroComprasCliente,ClientesRegistrados)
SELECT DC.KeyCliente,DT.KeyTiempo,DO.KeyOrganizacion,
SUM(NroComprasClientes.NroCompras) AS NROCOMPRASCLIENTE,
COUNT(C.CodCliente) AS ClientesRegistrados
FROM CLIENTE C INNER JOIN PEDIDO PED ON C.CodCliente = PED.CodCliente
INNER JOIN [DATAMART_DELTRON_BD].[dbo].[DIM_CLIENTE] AS DC ON DC.idCliente = C.CodCliente
INNER JOIN [DATAMART_DELTRON_BD].[dbo].[DIM_TIEMPO] AS DT ON DT.idFecha = CAST(PED.FechaPedido AS DATE)
INNER JOIN [DATAMART_DELTRON_BD].[dbo].[DIM_ORGANIZACION] AS DO ON DO.idDespacho = PED.CodDespacho
LEFT JOIN (SELECT c.CodCliente, COUNT(p.CodPedido) AS NroCompras
		   FROM Cliente c LEFT JOIN Pedido p ON c.CodCliente = p.CodCliente
        GROUP BY c.CodCliente
    ) AS NroComprasClientes ON NroComprasClientes.CodCliente = C.CodCliente
GROUP BY DC.KeyCliente,DT.KeyTiempo,DO.KeyOrganizacion




